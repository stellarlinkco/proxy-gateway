# Makefile for Claude Proxy Go Backend

# å˜é‡å®šä¹‰
BINARY_NAME=claude-proxy-go
MAIN_PATH=.
BUILD_DIR=../dist
AIR_VERSION=v1.52.0
# æ”¯æŒç¯å¢ƒå˜é‡è¦†ç›– VERSIONï¼ˆç”¨äº Docker æ„å»ºæ—¶ä¼ å…¥ï¼‰
VERSION?=$(shell cat ../VERSION 2>/dev/null || echo "v0.0.0-dev")
BUILD_TIME=$(shell date '+%Y-%m-%d_%H:%M:%S_%Z')
GIT_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
LDFLAGS=-X main.Version=$(VERSION) -X main.BuildTime=$(BUILD_TIME) -X main.GitCommit=$(GIT_COMMIT)

# é¢œè‰²è¾“å‡º
GREEN=\033[0;32m
YELLOW=\033[0;33m
NC=\033[0m # No Color

.PHONY: help dev build run clean install-air test copy-frontend

# é»˜è®¤ç›®æ ‡ - æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "$(GREEN)Claude Proxy Go Backend - å¯ç”¨å‘½ä»¤:$(NC)"
	@echo ""
	@echo "$(YELLOW)å¼€å‘å‘½ä»¤:$(NC)"
	@echo "  make dev          - å¯åŠ¨å¼€å‘æ¨¡å¼ (çƒ­é‡è½½)"
	@echo "  make install-air  - å®‰è£… Air çƒ­é‡è½½å·¥å…·"
	@echo ""
	@echo "$(YELLOW)æ„å»ºå‘½ä»¤:$(NC)"
	@echo "  make build        - æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
	@echo "  make run          - ç›´æ¥è¿è¡Œ (è‡ªåŠ¨å¤åˆ¶å‰ç«¯)"
	@echo "  make copy-frontend- å¤åˆ¶å‰ç«¯èµ„æº"
	@echo "  make clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo ""
	@echo "$(YELLOW)æµ‹è¯•å‘½ä»¤:$(NC)"
	@echo "  make test         - è¿è¡Œæµ‹è¯•"
	@echo "  make test-cover   - è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡"

# å®‰è£… Air å·¥å…·
install-air:
	@echo "$(GREEN)æ­£åœ¨å®‰è£… Air çƒ­é‡è½½å·¥å…·...$(NC)"
	@go install github.com/air-verse/air@latest
	@echo "$(GREEN)âœ… Air å®‰è£…å®Œæˆ!$(NC)"
	@echo "ä½¿ç”¨æ–¹æ³•: make dev"

# å¼€å‘æ¨¡å¼ - ä½¿ç”¨ Air çƒ­é‡è½½
dev:
	@if ! command -v air &> /dev/null; then \
		echo "$(YELLOW)âš ï¸  Air æœªå®‰è£…ï¼Œæ­£åœ¨è‡ªåŠ¨å®‰è£…...$(NC)"; \
		$(MAKE) install-air; \
	fi
	@echo "$(GREEN)ğŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼ (çƒ­é‡è½½å¼€å¯)$(NC)"
	@echo "$(YELLOW)ğŸ“ ç›‘å¬æ–‡ä»¶å˜åŒ–: *.go, *.yaml, *.toml, *.env$(NC)"
	@echo "$(YELLOW)ğŸ”„ ä¿®æ”¹ä»£ç åå°†è‡ªåŠ¨é‡å¯...$(NC)"
	@echo ""
	@air

# å¼€å‘æ¨¡å¼ - ä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡
dev-with-env:
	@echo "$(GREEN)ğŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼ (ä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡)$(NC)"
	@ENV_MODE=development air

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
build:
	@echo "$(GREEN)ğŸ“¦ æ„å»ºç”Ÿäº§ç‰ˆæœ¬...$(NC)"
	@CGO_ENABLED=0 go build -ldflags="$(LDFLAGS) -s -w" -o $(BUILD_DIR)/$(BINARY_NAME) $(MAIN_PATH)
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆ: $(BUILD_DIR)/$(BINARY_NAME)$(NC)"

# æ„å»ºå½“å‰å¹³å°ç‰ˆæœ¬
build-local:
	@echo "$(GREEN)ğŸ“¦ æ„å»ºæœ¬åœ°ç‰ˆæœ¬...$(NC)"
	@go build -o $(BINARY_NAME) $(MAIN_PATH)
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆ: ./$(BINARY_NAME)$(NC)"

# ç›´æ¥è¿è¡Œ (å¸¦ç‰ˆæœ¬ä¿¡æ¯)
run: copy-frontend
	@echo "$(GREEN)â–¶ï¸  ç›´æ¥è¿è¡Œ...$(NC)"
	@go run -ldflags="$(LDFLAGS)" $(MAIN_PATH)

# è¿è¡Œæµ‹è¯•
test:
	@echo "$(GREEN)ğŸ§ª è¿è¡Œæµ‹è¯•...$(NC)"
	@go test -v ./...

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
test-cover:
	@echo "$(GREEN)ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡...$(NC)"
	@go test -v -cover -coverprofile=coverage.out ./...
	@go tool cover -html=coverage.out -o coverage.html
	@echo "$(GREEN)âœ… è¦†ç›–ç‡æŠ¥å‘Šå·²ç”Ÿæˆ: coverage.html$(NC)"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "$(YELLOW)ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶...$(NC)"
	@rm -rf tmp/
	@rm -rf frontend/dist/
	@rm -f $(BINARY_NAME)
	@rm -f $(BUILD_DIR)/$(BINARY_NAME)
	@rm -f coverage.out coverage.html
	@rm -f build-errors.log
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(NC)"

# å¤åˆ¶å‰ç«¯èµ„æº
copy-frontend:
	@echo "$(GREEN)ğŸ“¦ å¤åˆ¶å‰ç«¯èµ„æº...$(NC)"
	@rm -rf frontend/dist
	@mkdir -p frontend/dist
	@if [ -d "../frontend/dist" ]; then \
		cp -r ../frontend/dist/* frontend/dist/; \
		echo "$(GREEN)âœ… å‰ç«¯èµ„æºå¤åˆ¶å®Œæˆ$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  å‰ç«¯æ„å»ºäº§ç‰©ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ„å»ºå‰ç«¯: cd ../frontend && bun run build$(NC)"; \
	fi

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "$(GREEN)ğŸ¨ æ ¼å¼åŒ–ä»£ç ...$(NC)"
	@go fmt ./...
	@echo "$(GREEN)âœ… æ ¼å¼åŒ–å®Œæˆ$(NC)"

# ä»£ç æ£€æŸ¥
lint:
	@echo "$(GREEN)ğŸ” æ£€æŸ¥ä»£ç ...$(NC)"
	@if ! command -v golangci-lint &> /dev/null; then \
		echo "$(YELLOW)å®‰è£… golangci-lint...$(NC)"; \
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
	fi
	@golangci-lint run

# ä¾èµ–ç®¡ç†
deps:
	@echo "$(GREEN)ğŸ“š æ›´æ–°ä¾èµ–...$(NC)"
	@go mod tidy
	@go mod download
	@echo "$(GREEN)âœ… ä¾èµ–æ›´æ–°å®Œæˆ$(NC)"

# æŸ¥çœ‹ä¾èµ–æ ‘
deps-tree:
	@echo "$(GREEN)ğŸŒ³ ä¾èµ–æ ‘:$(NC)"
	@go mod graph

# å®‰è£…å¼€å‘å·¥å…·
install-tools: install-air
	@echo "$(GREEN)ğŸ”§ å®‰è£…å¼€å‘å·¥å…·...$(NC)"
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "$(GREEN)âœ… æ‰€æœ‰å·¥å…·å®‰è£…å®Œæˆ$(NC)"